<html><head>
  <script type="text/javascript" src="akihabara/gbox.js"></script>
  <script type="text/javascript" src="akihabara/iphopad.js"></script>
  <script type="text/javascript" src="akihabara/trigo.js"></script>
  <script type="text/javascript" src="akihabara/toys.js"></script>
  <script type="text/javascript" src="akihabara/help.js"></script>
  <script type="text/javascript" src="akihabara/tool.js"></script>
  <script type="text/javascript" src="akihabara/gamecycle.js"></script>
  <script type="text/javascript" src="lib/a_star.js"></script>
  <script type="text/javascript" src="lib/jquery-1.4.2.js"></script>
  <script type="text/javascript" src="lib/jquery.lowpro.js"></script>
  <script type="text/javascript" src="lib/screen.js"></script>
  <script type="text/javascript" src="lib/core/object.js"></script>
  <script type="text/javascript" src="lib/actors/basic_box.js"></script>
  <script type="text/javascript" src="lib/mouse.js"></script>
  <script type="text/javascript" src="lib/planet.js"></script>

  <link rel="stylesheet" href="resources/style.css">
  <style>BODY { -webkit-user-select: none; margin: 0px }</style>
  <meta name="viewport" content="width=device-width; initial-scale=1.0; maximum-scale=1.0; user-scalable=0;" />
  <script>
var maingame;
var map;
// This keeps track of how many frames have been rendered in total
var frameCount = 0;
var TIME_LIMIT = 10; // This will determine how many seconds the player must survive to win
var timeStarted;     // This will record the current time when the game started
var pathMap;
var mx, my;

window.addEventListener('load', loadResources, false);

function loadResources() {
  // We're passing some overrides to help.akihabaraInit to set our title, resolution, and zoom factor
  help.akihabaraInit({
    title: '8by5',
    width: 640,
    height: 480,
    zoom: 1
  });

  gbox.addBundle({ file: 'resources/bundle.js' });

  gbox.setAudioChannels({ bgmusic: { volume: 0.5 }, sfx: { volume: 1.0 }});

  gbox.loadAll(setup);
};

function setup() {
  gbox.setGroups(['mouse', 'background', 'bullets', 'player', 'boxes', 'enemy', 'game']);

  maingame = gamecycle.createMaingame('game', 'game');

  maingame.gameMenu = function() { return true; };
  maingame.gameIntroAnimation = function() { return true; };
  maingame.gameTitleIntroAnimation = introScreenAnimation;
  maingame.initializeGame = function() {
    addMouseControl();

    addPlayer();

    // This gives us the time at which the game started,
    //  in milliseconds since the epoch
    timeStarted = (new Date()).getTime();

    // This adds a "label" widget, with "small"-font text to the screen
    //  located 25 pixels down from the top of the screen and
    //  40 pixels back from the right side of the screen
    maingame.hud.setWidget('time_left', {
      widget: 'label',
      font:   'small',
      value:  0,
      dx:     gbox.getScreenW() - 40,
      dy:     25,
      clear:  true
    });

    maingame.hud.setWidget('mouse_pos', {
      widget: 'label',
      font:   'small',
      value:  0,
      dx:     gbox.getScreenW() - 160,
      dy:     25,
      clear:  true
    });

    new BasicBox({ x: 60, y: 60, height: 50, width: 50 });

    new BasicBox({ x: 150, y: 150, height: 50, width: 50, color: 'rgb(0, 100, 200)' });
    new BasicBox({ x: 150, y: 250, height: 75, width: 75, color: 'rgb(100, 100, 200)' });
    new BasicBox({ x: 350, y: 40, height: 100, width: 100, color: 'rgb(100, 200, 200)' });
	
	planetFactory.createPlanet('null',0,0,'playTrack');
	planetFactory.createPlanet('null',0,0,'playTrack');
	planetFactory.createPlanet('planet-0',60,1,'fullVolume');
	planetFactory.createPlanet('planet-1',30,3,'fullVolume');
	planetFactory.createPlanet('planet-1',50,2,'fullVolume');
	planetFactory.createPlanet('planet-1',70,5,'fullVolume');
	
	planetFactory.createPlanet('planet-0-planet-0',20,6,'lowerHalfVolume');
  };

  gbox.go();
}

function introScreenAnimation(reset) {
  // var introScreen = new IntroScreen();
  // introScreen.run();
  // if (reset) {
  //   toys.resetToy(this, 'rising');
  // }
  // 
  // gbox.blitFade(gbox.getBufferContext(), { alpha: 1 });
  // 
  // toys.logos.linear(this, 'rising', {
  //   image: 'logo',
  //   sx:    gbox.getScreenW()/2 - gbox.getImage('logo').width/2,
  //   sy:    gbox.getScreenH(),
  //   x:     gbox.getScreenW()/2 - gbox.getImage('logo').width/2,
  //   y:     20,
  //   speed: 1
  // });
};

function loadMap() {
  return help.asciiArtToMap([
"xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx",
"x                  xx                  x",
"x                  xx                  x",
"xxxxxxxx      x    xx                  x",
"x             x    xxxxxxxxxx          x",
"x             x                        x",
"x             x                        x",
"x     xxxx  xxxxxxxxx           xxxxxxxx",
"x                  xx                  x",
"x                  xx                  x",
"xxxx               xx                  x",
"x      xxxxxxxxx   xx                  x",
"x                  xx                  x",
"x                  xx        x         x",
"xxxxxxx  xxxxxxxxxxxx        x         x",
"xxxxxxx  xxxxxxxxxxxx        x         x",
"x                  xx      xxxx        x",
"x                  xx        x         x",
"xxxxxxxx      x    xx        x         x",
"x             x    xx                  x",
"x             x    xx                  x",
"x             x    xx                  x",
"x     xxxx  xxxxxxxxx                  x",
"x                  xx                  x",
"xxxx                                   x",
"x                                      x",
"x      xxxxxxxxx   xx                  x",
"x                  xx                  x",
"xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx",
    ], [ [null, ' '], [0, 'x'] ])
}

function gameOverWin() {
  //maingame.setState(801);
}

function callWhenColliding(obj,group,call) {
  for (var i in gbox._objects[group])
    if ((!gbox._objects[group][i].initialize) && toys.topview.collides(obj, gbox._objects[group][i]))
      if (gbox._objects[group][i][call]) {
        gbox._objects[group][i][call](obj);
        return i;
      }
  return false;
}

// This is our function for adding the player object -- this keeps our main game code nice and clean
function addPlayer() {
  gbox.addObject({
    id:      'player_id',    // id refers to the specific object.
    group:   'player',       // The rendering group
    tileset: 'player_tiles', // tileset is where the graphics come from.
    colh: gbox.getTiles('player_tiles').tileh,

    initialize: function() {
      toys.topview.initialize(this, {});
      this.x = 20;
      this.y = 20;
      this.mx = 0;
      this.my = 0;
      this.theta = 0;

      // Here we define the list of animations. We can name these whatever we want.
      // These are referenced with this.animList[id].
      // So for example, this.animList[rightDown].frames[1] would return 12.
      this.animList = {
        still:     { speed: 1, frames: [0]     },
        right:     { speed: 3, frames: [1, 11] },
        rightDown: { speed: 3, frames: [2, 12] },
        down:      { speed: 3, frames: [3, 13] },
        downLeft:  { speed: 3, frames: [4, 14] },
        left:      { speed: 3, frames: [5, 15] },
        leftUp:    { speed: 3, frames: [6, 16] },
        up:        { speed: 3, frames: [7, 17] },
        upRight:   { speed: 3, frames: [8, 18] }
      };

      // Set the starting animation for the player object.
      this.animIndex = 'still';
    },
    first: function() {
      toys.topview.controlKeys(this, { left: 'left', right: 'right', up: 'up', down: 'down' });

      // The if statements check for accelerations in the x and y directions and whether they are positive or negative. It then sets the animation index to the keyword corresponding to that direction.
      if (this.accx == 0 && this.accy == 0) this.animIndex = 'still';
      if (this.accx > 0 && this.accy == 0)  this.animIndex = 'right';
      if (this.accx > 0 && this.accy > 0)   this.animIndex = 'rightDown';
      if (this.accx == 0 && this.accy > 0)  this.animIndex = 'down';
      if (this.accx < 0 && this.accy > 0)   this.animIndex = 'downLeft';
      if (this.accx < 0 && this.accy == 0)  this.animIndex = 'left';
      if (this.accx < 0 && this.accy < 0)   this.animIndex = 'leftUp';
      if (this.accx == 0 && this.accy < 0)  this.animIndex = 'up';
      if (this.accx > 0 && this.accy < 0)   this.animIndex = "upRight";

      // Set the animation.
      if (frameCount%this.animList[this.animIndex].speed == 0)
      this.frame = help.decideFrame(frameCount, this.animList[this.animIndex]);

      toys.topview.handleAccellerations(this);
      toys.topview.applyForces(this);

      callWhenColliding(this, 'enemy', 'gameOverFail');
    },

    blit: function() {
      gbox.blitFade(gbox.getBufferContext(), { alpha: 1 });

      gbox.blitTile(gbox.getBufferContext(), {
        tileset: this.tileset,
        tile:    this.frame,
        dx:      this.x,
        dy:      this.y,
        fliph:   this.fliph,
        flipv:   this.flipv,
        camera:  this.camera,
        alpha:   1.0
      });
    },
  });
}

</script>
</head><body></body></html>